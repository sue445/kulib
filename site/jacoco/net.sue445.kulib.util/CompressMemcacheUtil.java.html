<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>CompressMemcacheUtil.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">kulib</a> &gt; <a href="index.html" class="el_package">net.sue445.kulib.util</a> &gt; <span class="el_source">CompressMemcacheUtil.java</span></div><h1>CompressMemcacheUtil.java</h1><pre class="source lang-java linenums">package net.sue445.kulib.util;


import java.io.BufferedInputStream;
import java.io.BufferedOutputStream;
import java.io.ByteArrayInputStream;
import java.io.ByteArrayOutputStream;
import java.io.Closeable;
import java.io.IOException;
import java.io.ObjectInputStream;
import java.io.ObjectOutputStream;
import java.util.logging.Level;
import java.util.logging.Logger;
import java.util.zip.GZIPInputStream;
import java.util.zip.GZIPOutputStream;

import org.slim3.memcache.Memcache;

import com.google.appengine.api.memcache.Expiration;

/**
 * put a compressed serialize object to Memcache
 * &lt;br&gt;
 * note: this util is not support hot reloading
 * @author sue445
 *
 */
public final class CompressMemcacheUtil {
	private static final int END_OF_DATA = -1;

	private static final int UNCOMPRESS_BUFFER_SIZE = 1024*1024*2;	// 2MB

<span class="fc" id="L33">	private static final Logger logger = Logger.getLogger(CompressMemcacheUtil.class.getName());</span>


<span class="nc" id="L36">	private CompressMemcacheUtil(){</span>

<span class="nc" id="L38">	}</span>

	/**
	 * put a compressed object to Memcache
	 * @param key
	 * @param src
	 */
	public static void put(Object key, Object src) {
		try {
<span class="fc" id="L47">			Memcache.put(key, compress(serialize(src)));</span>
<span class="nc" id="L48">		} catch (Exception e) {</span>
<span class="nc" id="L49">			logger.log(Level.SEVERE, &quot;put failed: key=&quot; + key, e);</span>
<span class="fc" id="L50">		}</span>
<span class="fc" id="L51">	}</span>

	/**
	 * put a compressed object to Memcache
	 * @param key
	 * @param src
	 * @param expiration
	 */
	public static void put(Object key, Object src, Expiration expiration) {
		try {
<span class="fc" id="L61">			Memcache.put(key, compress(serialize(src)), expiration);</span>
<span class="nc" id="L62">		} catch (Exception e) {</span>
<span class="nc" id="L63">			logger.log(Level.SEVERE, &quot;put failed: key=&quot; + key, e);</span>
<span class="fc" id="L64">		}</span>
<span class="fc" id="L65">	}</span>

	/**
	 * serialize a object
	 * @param src	a object
	 * @return	serialized binary
	 * @throws IOException
	 */
	public static byte[] serialize(Object src) throws IOException {
<span class="fc bfc" id="L74" title="All 2 branches covered.">		if(src == null){</span>
<span class="fc" id="L75">			return null;</span>
		}

<span class="fc" id="L78">		ObjectOutputStream oos = null;</span>
<span class="fc" id="L79">		long start = System.currentTimeMillis();</span>
		try {
<span class="fc" id="L81">			ByteArrayOutputStream baos = new ByteArrayOutputStream();</span>
<span class="fc" id="L82">			oos = new ObjectOutputStream(baos);</span>
<span class="fc" id="L83">			oos.writeObject(src);</span>
<span class="fc" id="L84">			oos.flush();</span>
<span class="fc" id="L85">			return baos.toByteArray();</span>

		} finally{
<span class="pc" id="L88">			closeQuietly(oos);</span>
<span class="pc" id="L89">			printEndMessage(&quot;serialize:&quot;, start);</span>
		}
	}

	/**
	 * close stream (ignore null and exception)
	 * @param stream
	 */
	private static void closeQuietly(Closeable stream) {
<span class="pc bpc" id="L98" title="1 of 2 branches missed.">		if(stream == null){</span>
<span class="nc" id="L99">			return;</span>
		}

		try {
<span class="fc" id="L103">			stream.close();</span>

<span class="nc" id="L105">		} catch (IOException e) {</span>
<span class="nc" id="L106">			logger.log(Level.WARNING, &quot;failed stream close&quot;, e);</span>
<span class="fc" id="L107">		}</span>
<span class="fc" id="L108">	}</span>

	/**
	 * print message with processed time
	 * @param msg
	 * @param start
	 */
	private static void printEndMessage(String msg, long start) {
<span class="fc" id="L116">		long time = System.currentTimeMillis() - start;</span>

<span class="pc bpc" id="L118" title="1 of 2 branches missed.">		if(logger.isLoggable(Level.FINEST)){</span>
<span class="nc" id="L119">			logger.log(Level.FINEST, msg + time + &quot;ms&quot;);</span>
		}
<span class="fc" id="L121">	}</span>

	/**
	 * compress binary
	 * @param src	uncompressed binary
	 * @return		compressed binary
	 * @throws IOException
	 */
	public static byte[] compress(byte[] src) throws IOException {
<span class="fc bfc" id="L130" title="All 2 branches covered.">		if(isEmpty(src)){</span>
<span class="fc" id="L131">			return null;</span>
		}

<span class="fc" id="L134">		long start = System.currentTimeMillis();</span>
<span class="fc" id="L135">		GZIPOutputStream gos = null;</span>
		try {
<span class="fc" id="L137">			ByteArrayOutputStream baos = new ByteArrayOutputStream();</span>
<span class="fc" id="L138">			gos = new GZIPOutputStream(baos);</span>
<span class="fc" id="L139">			gos.write(src);</span>
<span class="fc" id="L140">			gos.flush();</span>
<span class="fc" id="L141">			gos.finish();</span>
<span class="fc" id="L142">			byte[] result = baos.toByteArray();</span>

<span class="pc bpc" id="L144" title="1 of 2 branches missed.">			if(logger.isLoggable(Level.FINEST)){</span>
<span class="nc" id="L145">				logger.log(Level.FINEST, &quot;compressed: &quot; + src.length + &quot;bytes -&gt; &quot; + result.length + &quot;bytes&quot;);</span>
			}

<span class="fc" id="L148">			return result;</span>

		} finally{
<span class="pc" id="L151">			closeQuietly(gos);</span>
<span class="pc" id="L152">			printEndMessage(&quot;compress:&quot;, start);</span>
		}
	}

	/**
	 * whether an empty array
	 * @param src
	 * @return
	 */
	private static boolean isEmpty(byte[] src) {
<span class="pc bpc" id="L162" title="1 of 4 branches missed.">		return src == null || src.length == 0;</span>
	}

	/**
	 * get a compressed object from Memcache
	 * @param key
	 * @return
	 */
	@SuppressWarnings(&quot;unchecked&quot;)
	public static &lt;T&gt; T get(Object key) {
		try {
<span class="fc" id="L173">			return (T)deserialize(uncompress((byte[])Memcache.get(key)));</span>
<span class="nc" id="L174">		} catch (Exception e) {</span>
<span class="nc" id="L175">			logger.log(Level.SEVERE, &quot;get failed: key=&quot; + key, e);</span>
<span class="nc" id="L176">			return null;</span>
		}
	}

	/**
	 * uncompress binary
	 * @param src	compressed binary
	 * @return		uncompressed binary
	 * @throws IOException
	 */
	public static byte[] uncompress(byte[] src) throws IOException {
<span class="fc bfc" id="L187" title="All 2 branches covered.">		if(isEmpty(src)){</span>
<span class="fc" id="L188">			return null;</span>
		}

<span class="fc" id="L191">		GZIPInputStream gis = null;</span>
<span class="fc" id="L192">		BufferedOutputStream bos = null;</span>
<span class="fc" id="L193">		long start = System.currentTimeMillis();</span>

		try {
<span class="fc" id="L196">			gis =  new GZIPInputStream(new BufferedInputStream(new ByteArrayInputStream(src)));</span>
<span class="fc" id="L197">			ByteArrayOutputStream baos = new ByteArrayOutputStream();</span>
<span class="fc" id="L198">			bos = new BufferedOutputStream(baos);</span>

<span class="fc" id="L200">			byte[] buffer = new byte[UNCOMPRESS_BUFFER_SIZE];</span>
			while(true){
<span class="fc" id="L202">				int readSize = gis.read(buffer);</span>
<span class="fc bfc" id="L203" title="All 2 branches covered.">				if(readSize == END_OF_DATA){</span>
<span class="fc" id="L204">					break;</span>
				}
<span class="fc" id="L206">				baos.write(buffer, 0, readSize);</span>
<span class="fc" id="L207">			}</span>
<span class="fc" id="L208">			baos.flush();</span>

<span class="fc" id="L210">			byte[] result = baos.toByteArray();</span>

<span class="pc bpc" id="L212" title="1 of 2 branches missed.">			if(logger.isLoggable(Level.FINEST)){</span>
<span class="nc" id="L213">				logger.log(Level.FINEST, &quot;uncompressed: &quot; + src.length + &quot;bytes -&gt; &quot; + result.length + &quot;bytes&quot;);</span>
			}

<span class="fc" id="L216">			return result;</span>

		} finally{
<span class="pc" id="L219">			closeQuietly(bos);</span>
<span class="pc" id="L220">			closeQuietly(gis);</span>
<span class="pc" id="L221">			printEndMessage(&quot;uncompressed:&quot;, start);</span>
		}
	}

	/**
	 * deserialize to object
	 * @param src	serialized binary
	 * @return		deserialized object
	 * @throws ClassNotFoundException
	 * @throws IOException
	 */
	@SuppressWarnings(&quot;unchecked&quot;)
	public static &lt;T&gt; T deserialize(byte[] src) throws IOException, ClassNotFoundException {
<span class="fc bfc" id="L234" title="All 2 branches covered.">		if(isEmpty(src)){</span>
<span class="fc" id="L235">			return null;</span>
		}

<span class="fc" id="L238">		ObjectInputStream ois = null;</span>
<span class="fc" id="L239">		long start = System.currentTimeMillis();</span>

		try {
<span class="fc" id="L242">			ois = new ObjectInputStream(new ByteArrayInputStream(src));</span>
<span class="fc" id="L243">			return (T) ois.readObject();</span>

		} finally{
<span class="pc" id="L246">			closeQuietly(ois);</span>
<span class="pc" id="L247">			printEndMessage(&quot;deserialize:&quot;, start);</span>
		}
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.5.10.201208310627</span></div></body></html>