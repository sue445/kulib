<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="ja"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>DateLoggingFilter.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">kulib</a> &gt; <a href="index.html" class="el_package">net.sue445.kulib.filter</a> &gt; <span class="el_source">DateLoggingFilter.java</span></div><h1>DateLoggingFilter.java</h1><pre class="source lang-java linenums">package net.sue445.kulib.filter;

import java.io.IOException;
import java.text.DateFormat;
import java.text.SimpleDateFormat;
import java.util.Date;
import java.util.TimeZone;
import java.util.logging.Level;
import java.util.logging.Logger;

import javax.servlet.Filter;
import javax.servlet.FilterChain;
import javax.servlet.FilterConfig;
import javax.servlet.ServletException;
import javax.servlet.ServletRequest;
import javax.servlet.ServletResponse;

import org.slim3.util.DateUtil;
import org.slim3.util.StringUtil;

/**
 * print timestamp when controller begin and end.
 * example
 * &lt;pre&gt;
 *     &amp;lt;filter&amp;gt;
 *         &amp;lt;filter-name&amp;gt;DateLoggingFilter&amp;lt;/filter-name&amp;gt;
 *         &amp;lt;filter-class&amp;gt;net.sue445.kulib.filter.DateLoggingFilter&amp;lt;/filter-class&amp;gt;
 *         &amp;lt;init-param&amp;gt;
 *             &amp;lt;param-name&amp;gt;timestampFormat&amp;lt;/param-name&amp;gt;
 *             &amp;lt;param-value&amp;gt;yyyy/MM/dd HH:mm:ss.SSS z&amp;lt;/param-value&amp;gt;
 *         &amp;lt;/init-param&amp;gt;
 *         &amp;lt;init-param&amp;gt;
 *             &amp;lt;param-name&amp;gt;timeZone&amp;lt;/param-name&amp;gt;
 *             &amp;lt;param-value&amp;gt;Asia/Tokyo&amp;lt;/param-value&amp;gt;
 *         &amp;lt;/init-param&amp;gt;
 *     &amp;lt;/filter&amp;gt;
 *
 *     &amp;lt;!-- insert this before FrontController --&amp;gt;
 *     &amp;lt;filter-mapping&amp;gt;
 *         &amp;lt;filter-name&amp;gt;DateLoggingFilter&amp;lt;/filter-name&amp;gt;
 *         &amp;lt;url-pattern&amp;gt;/*&amp;lt;/url-pattern&amp;gt;
 *         &amp;lt;dispatcher&amp;gt;REQUEST&amp;lt;/dispatcher&amp;gt;
 *     &amp;lt;/filter-mapping&amp;gt;
 *
 *     &amp;lt;filter-mapping&amp;gt;
 *         &amp;lt;filter-name&amp;gt;FrontController&amp;lt;/filter-name&amp;gt;
 *         ....
 *
 * &lt;/pre&gt;
 * @author sue445
 *
 */
<span class="fc" id="L53">public class DateLoggingFilter implements Filter {</span>
<span class="fc" id="L54">	protected static final Logger logger = Logger.getLogger(DateLoggingFilter.class.getName());</span>

	private static final String TIMESTAMP_FORMAT_KEY = &quot;timestampFormat&quot;;
	private static final String TIME_ZONE_KEY = &quot;timeZone&quot;;

	private String timestampFormat;

	private TimeZone timeZone;


	/**
	 * {@inheritDoc}
	 */
	@Override
	public void init(FilterConfig config) throws ServletException {
<span class="fc" id="L69">		initTimestampFormat(config);</span>
<span class="fc" id="L70">		initTimeZone(config);</span>

<span class="pc bpc" id="L72" title="1 of 2 branches missed.">		if(logger.isLoggable(Level.FINEST)){</span>
<span class="nc" id="L73">			logger.log(Level.FINEST, &quot;Initialized :timestampFormat=&quot; + timestampFormat + &quot;,timeZone=&quot; + timeZone.getDisplayName());</span>
		}
<span class="fc" id="L75">	}</span>

	/**
	 * initialize timestamp format with &amp;lt;init-param&amp;gt; (default: yyyy-MM-dd'T'HH:mm:ss)
	 * @param config
	 */
	private void initTimestampFormat(FilterConfig config) {
<span class="fc" id="L82">		String timestampFormat = config.getInitParameter(TIMESTAMP_FORMAT_KEY);</span>
<span class="fc bfc" id="L83" title="All 2 branches covered.">		if(StringUtil.isEmpty(timestampFormat)){</span>
<span class="fc" id="L84">			this.timestampFormat = DateUtil.ISO_DATE_TIME_PATTERN;</span>
		} else{
<span class="fc" id="L86">			this.timestampFormat = timestampFormat;</span>
		}
<span class="fc" id="L88">	}</span>

	/**
	 * initialize timezone format with &amp;lt;init-param&amp;gt;
	 * @param config
	 */
	private void initTimeZone(FilterConfig config){
<span class="fc" id="L95">		String timeZone = config.getInitParameter(TIME_ZONE_KEY);</span>
<span class="fc bfc" id="L96" title="All 2 branches covered.">		if(StringUtil.isEmpty(timeZone)){</span>
<span class="fc" id="L97">			this.timeZone = TimeZone.getDefault();</span>
		} else{
<span class="fc" id="L99">			this.timeZone = TimeZone.getTimeZone(timeZone);</span>
		}
<span class="fc" id="L101">	}</span>

	/**
	 * {@inheritDoc}
	 */
	@Override
	public void destroy() {
<span class="fc" id="L108">	}</span>

	/**
	 * {@inheritDoc}
	 */
	@Override
	public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain) throws IOException, ServletException {
<span class="fc" id="L115">		DateFormat df = createDateFormat();</span>

<span class="fc" id="L117">		printStartLog(df);</span>

<span class="fc" id="L119">		long startTime = System.currentTimeMillis();</span>

		try {
<span class="fc" id="L122">			chain.doFilter(request, response);</span>

		} finally{
<span class="pc" id="L125">			printEndLog(df, startTime);</span>
<span class="fc" id="L126">		}</span>
<span class="fc" id="L127">	}</span>

	/**
	 *
	 * @return
	 */
	private DateFormat createDateFormat() {
<span class="fc" id="L134">		DateFormat df = new SimpleDateFormat(this.timestampFormat);</span>
<span class="fc" id="L135">		df.setTimeZone(this.timeZone);</span>
<span class="fc" id="L136">		return df;</span>
	}

	/**
	 *
	 * @param df
	 */
	private void printStartLog(DateFormat df) {
<span class="pc bpc" id="L144" title="1 of 2 branches missed.">		if(logger.isLoggable(Level.FINEST)){</span>
<span class="nc" id="L145">			String currentTime = createCurrentTime(df);</span>
<span class="nc" id="L146">			logger.log(Level.FINEST, currentTime);</span>
		}
<span class="fc" id="L148">	}</span>

	/**
	 *
	 * @param df
	 * @param startTime
	 */
	private void printEndLog(DateFormat df, long startTime) {
<span class="pc bpc" id="L156" title="1 of 2 branches missed.">		if(logger.isLoggable(Level.FINEST)){</span>
<span class="nc" id="L157">			String currentTime = createCurrentTime(df);</span>
<span class="nc" id="L158">			long endTime = System.currentTimeMillis();</span>

<span class="nc" id="L160">			StringBuilder sb = new StringBuilder();</span>
<span class="nc" id="L161">			sb.append(currentTime);</span>
<span class="nc" id="L162">			sb.append(&quot; (&quot;);</span>
<span class="nc" id="L163">			sb.append(endTime - startTime);</span>
<span class="nc" id="L164">			sb.append(&quot;ms)&quot;);</span>

<span class="nc" id="L166">			logger.log(Level.FINEST, sb.toString());</span>
		}
<span class="fc" id="L168">	}</span>

	/**
	 *
	 * @return
	 */
	private String createCurrentTime(DateFormat df) {
<span class="nc" id="L175">		return df.format(new Date());</span>
	}

	/**
	 * @return timestampFormat
	 */
	protected String getTimestampFormat() {
<span class="fc" id="L182">		return timestampFormat;</span>
	}

	/**
	 * @return timeZone
	 */
	protected TimeZone getTimeZone() {
<span class="fc" id="L189">		return timeZone;</span>
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.5.10.201208310627</span></div></body></html>